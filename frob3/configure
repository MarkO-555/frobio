#!/bin/bash
set -eu
exec >&2

function fail () {
  echo "FAILURE: $*" >&2
  exit 13
}

BUILD="$PWD"
echo "BUILD directory : $BUILD"
F=$(dirname $0)
echo "FROB3 directory : $F"

NITROS9=${NITROS9DIR:-$(dirname $(dirname $F))/nitros9}
case $# in
  1)
    case $1 in
      --nitros9=* )
        NITROS9=$(expr match "$1" '--nitros9=\(.*\)') ;;
        * ) fail Bad argument: $1 ;;
    esac ;;
esac
echo "NITROS9 directory : $NITROS9"

LWASM=$(which lwasm || fail "Cannot find 'lwasm' command.")
LWLINK=$(which lwlink || fail "Cannot find 'lwlink' command.")
CMOC=$(which cmoc || fail "Cannot find 'cmoc' command.")
GCC6809=$(which m6809-unknown-gcc || fail "Cannot find 'm6809-unknown-gcc' command.")
OS9=$(which os9 || fail "Cannot find 'os9' command.")
DECB=$(which decb || fail "Cannot find 'decb' command.")
GO=$(which go || fail "Cannot find 'go' command.")

test -x "$LWASM" || fail "Cannot find 'lwasm' command."
test -x "$LWLINK" || fail "Cannot find 'lwlink' command."
test -x "$CMOC" || fail "Cannot find 'cmoc' command."
test -x "$GCC6809" || fail "Cannot find 'm6809-unknown-gcc' command."
test -x "$OS9" || fail "Cannot find 'os9' command."
test -x "$DECB" || fail "Cannot find 'decb' command."
test -x "$GO" || fail "Cannot find 'go' command."

echo Found lwasm at $LWASM
echo Found lwlink at $LWLINK
echo Found cmoc at $CMOC
echo Found m6809-unknown-gcc at $GCC6809
echo Found os9 at $OS9
echo Found decb at $DECB
echo Found go at $GO

echo Writing config.txt
cat <<,,,,,,,, >config.txt
export F=$F
export NITROS9=$NITROS9

export LWASM=$LWASM
export LWLINK=$LWLINK

export CMOC=$CMOC
export CMOCI=$(dirname $(dirname $CMOC))/share/cmoc/include
export CMOCL=$(dirname $(dirname $CMOC))/share/cmoc/lib

export GCC6809=$GCC6809
export OS9=$OS9
export DECB=$DECB
export GO=$GO
export BUILD=$BUILD
,,,,,,,,

cp -v $F/Makefile.in Makefile
echo "OKAY."
